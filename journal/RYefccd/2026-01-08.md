
### atlas

#### 安装

安装 atlas:

> curl -sSf https://atlasgo.sh | sh

或者使用代理

> curl -sSf https://atlasgo.sh |proxychains sh

#### 反射生成数据库模式文件:

```bash
atlas schema inspect --url "postgresql://postgres:123qwe@localhost:5432/brde_db?sslmode=disable" > schema.hcl
```

#### 查看数据的 er 图:

```bash
atlas schema inspect --url "postgresql://postgres:123qwe@localhost:5432/brde_db?sslmode=disable" --web
```

#### 生成数据库模式变更脚本

```bash
atlas migrate diff --env local --dev-url "docker://postgres/16"
```

这样会在 sqlalchemy env 配置中的 migration.dir 生成相关的数据库表模式迁移文件.

  
#### 数据库模式变更文件在目标数据库执行同步

```bash
atlas schema apply --env local --url "postgresql://postgres:123qwe@localhost:5432/brde_db?sslmode=disable" --dev-url "docker://postgres/16" ## 如无docker，则准备一个空的数据库.
```

#### 清空数据库

```bash
atlas schema clean --env local --url "postgresql://postgres:123qwe@localhost:5432/brde_db?sslmode=disable"
```

  

**在生产中应用数据库变更脚本需要注意如下要点**:

  

1. 不要对数据库表中的字段进行删除和类型修改. 这会让之前依赖此字段的程序运行报错.

2. 新增的数据库字段必须设置允许NULL值或者在服务端为此字段设置默认值，避免其他程序因为新的字段非空导致运行异常.

3. 按照生成的顺序去执行得到的数据库迁移文件.

### sqlalchemy 与 数据库字段非空

```python
class BrdeUser(Base):

__tablename__ = 'brde_user'

id: Mapped[str] = mapped_column(String, primary_key=True)
username: Mapped[str] = mapped_column(String, unique=True)
f1: Mapped[str] = mapped_column(String, nullable=False, server_default='xxx', default='xxx')
f2: Mapped[str] = mapped_column(String, nullable=True)

```


假设新增 f1, f2 字段, 那么程序中判断这些字段的区别:

判断 f1:
f1 字段一定非空
```python
if f1=="xxx": # 表示默认由数据库写入的字段.
	pass
```

判断 f2:
f2 字段可以为空，所以很多时候判断非空，再判断业务上的值:

```python
if f2 is not None and f2=="xxx":
	pass
```


### atlas

diff two table schame fefine:

```bash
atlas schema diff --from "mysql://root:pass@localhost:3306/db" --to "file://schema.hcl"
```


The error **"required flag(s) 'to' not set"** in Atlas (atlasgo) typically occurs when executing a command that requires a target destination or state, but the `--to` flag is missing from your command.

Common Causes and Fixes

This error most frequently appears during **declarative schema migrations** or **schema diffing** where a target state must be defined.

- **`atlas schema apply`**: This command requires you to specify the desired state. You must use the `--to` flag to point to your schema file (e.g., HCL or SQL) or another database URL.
    - **Fix:** `atlas schema apply --url "mysql://root:pass@localhost:3306/db" --to "file://schema.hcl"`
- **`atlas schema diff`**: Similar to `apply`, the `diff` command compares two states. It requires both a source (`--from`) and a target (`--to`).
    - **Fix:** `atlas schema diff --from "mysql://root:pass@localhost:3306/db" --to "file://schema.hcl"`
- **Versioned Migrations**: If you are trying to generate a migration from a schema file to a migration directory, ensure both flags are present.
    - **Fix:** `atlas migrate diff name --dir "file://migrations" --to "file://schema.hcl" --dev-url "docker://mysql/8"`


1. **`--to`**: Specifies the target state. This can be a URL to a database, a path to a schema file (`file://...`), or an Atlas Cloud schema.
2. **`--url`**: Used in `apply` to specify which database you are modifying.
3. **`--from`**: Used in `diff` to specify the starting state for comparison.



Troubleshooting Steps

- **Verify Environment Variables**: If you are using an `atlas.hcl` [project configuration file](https://atlasgo.io/atlas-schema/projects), ensure your environment block defines the `src` or `to` attribute correctly so the CLI can pick it up automatically when using the `--env` flag.
- **Check Command Syntax**: Ensure there is a space between the flag and its value (e.g., `--to file://schema.hcl` not `--tofile://schema.hcl`).
- **Atlas Version**: Ensure you are using a current version of the Atlas CLI (current as of 2026), as flag requirements may vary between very old and modern versions.